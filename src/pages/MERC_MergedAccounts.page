<apex:page showHeader="true" sidebar="false" tabStyle="Account" controller="MERC_MergedAccountsController">
	<apex:includeScript value="{!urlfor($Resource.mercury, 'js/jquery.min.js')}"/>
	<script>$ = jQuery.noConflict();</script>
	<apex:sectionHeader title="Accounts" subtitle="Merge Related Data" />
	<apex:form >
		<apex:pageBlock id="thePageBlock">

			<!-- TOP SECTION SHOWING ACCOUNTS -->
			<apex:pageBlockButtons location="top">
				<apex:commandButton value="Previous" action="{!ssc.previous}" rendered="{!ssc.hasPrevious}" reRender="thePageBlock"/>
				<apex:commandButton value="Next" action="{!ssc.next}" rendered="{!ssc.hasNext}" reRender="thePageBlock"/>
			</apex:pageBlockButtons>
			<apex:pageBlockSection title="Merged Accounts" collapsible="false" columns="1">
				<apex:pageBlockTable value="{!accounts}" var="acct" rowClasses="clickable" id="accountTable">
					<apex:column html-data-record-id="{!acct.detail.id}">
						<apex:inputCheckbox value="{!acct.selected}"/>
					</apex:column>
					<apex:repeat value="{!$ObjectType.Account.FieldSets.Merge_Account_Page_Main_List}" var="f">
        				<apex:column value="{!acct.detail[f]}"/>
    				</apex:repeat>
				</apex:pageBlockTable>
			</apex:pageBlockSection>
		</apex:pageBlock>

		<!-- JAVASCRIPT METHOD TO UPDATE THE RELATED LISTS -->
		<apex:actionFunction name="updateMergeObject" action="{!updateMergeObject}" reRender="relatedLists">
			<apex:param assignTo="{!activeAccountId}" name="selectedAccount" value=""/>
		</apex:actionFunction>

		<!-- THE RELATED LISTS -->
		<apex:pageBlock id="relatedLists">
			<apex:outputText value="{!NOW()}"/>
			<apex:repeat value="{!mergeObject.allRelatedLists}" var="rl">
				<apex:pageBlockSection title="{!rl.sObjectLabel}" collapsible="true" columns="2">
					<apex:pageBlockTable value="{!rl.winningList}" var="object">
						<apex:column rendered="{!rl.settings.Allow_Winning_Account_Deletes__c}">
							<apex:inputCheckbox value="{!object.selected}"/>
						</apex:column>
						<apex:repeat value="{!rl.winningFields}" var="field">
							<apex:column value="{!object.detail[field]}" />
						</apex:repeat>
					</apex:pageBlockTable>

					<apex:pageBlockTable value="{!rl.losingList}" var="object">
						<apex:column >
							<apex:inputCheckbox value="{!object.selected}"/>
						</apex:column>
						<apex:repeat value="{!rl.losingFields}" var="field">
							<apex:column value="{!object.detail[field]}" />
						</apex:repeat>
					</apex:pageBlockTable>
				</apex:pageBlockSection>
			</apex:repeat>
		</apex:pageBlock>
	</apex:form>

	<script>
		$(function () {
			$('input.account-check-box').on('click', function(e){
				//The checkboxes live inside the clickable rows. prevent the click of a
				//checkbox from invoking the row click
				e.stopPropagation();
			});

			$('tr.clickable').on('click', function(){
				//When a row is clicked get the account record Id
				//and call the actionfunction to update the related lists
				updateMergeObject($(this).children().first().data('record-id'));

			});
		});
	</script>
</apex:page>