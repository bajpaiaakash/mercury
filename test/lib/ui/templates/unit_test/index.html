{% extends "layouts/base.html" %}

{% block body_class %}test{% endblock %}

{% block yield %}

<link href="https://mavens-mavensconsulting.netdna-ssl.com/circleci/resources/css/progress.css" rel="stylesheet" type="text/css"/>

<style>
	.results_hidden {
	    display:none;
	}

	#mm_logger {
		display:none;
		height:200px;
		overflow-y:auto;
		padding:10px;
		border:1px solid #f2f2f2;
	}

	table.code {
		display:none;
	}

	table.code td {
		padding:0px;
	}

	table.code {
		border: 1px solid #CCC;
		width: 100%;
		border-collapse: collapse;
		font: 95%/105% "Consolas", Monaco, "Courier New", Courier, "Bitstream Vera Sans Mono", monospace;
	}

	table.code thead .line_numbers, table.code thead {
		background: #DDD;
	}

	table.code td.covered {
		background: #DFD;
	}

	table.code td.not_covered { 
		background: #fdd; 
	}

	table.code tr td.line_numbers {
		text-align: right;
		vertical-align: top;
		background: #EEE;
		color: #555;
		font-size: 90%;
		padding: 2px;
		padding-top: 0;
		width: 35px;
		border-right: 1px solid #CCC;
		border-bottom: 1px solid #DDD;
		vertical-align:middle;
	}

	table.code td {
		vertical-align:middle;
		border-top: 1px dotted #b5b5b5;
	}

	#tests_results .alert.block-message-custom,
	#ms-tests .alert.block-message-custom {
		background-image: none;
		-webkit-box-shadow: none;
		box-shadow: none;
		padding: 7px 12px;
		border:none;
		border-bottom:2px solid #ddd;
		margin-bottom:0px;
		border-radius: 4px 4px 0px 0px;
	}

	#tests_results .block-message-custom {
		padding: 5px 0px;
	}

	.alert-message .btn {
		font-weight:normal;
	}

	table.test_result {
		border-top:none;
	}
	table.test_result th, table.test_result td {
		padding:5px;
		line-height:1;
	}

	embed.hidden {
		position: absolute;
		left: -10000px;
	}

	.deploy_options label, .deploy_options div.divlabel {
		width:180px;
		font-weight: bold;
	}

	.deploy_options label {
		text-align: left;
	}

	.deploy_options .clearfix {
		margin-left: 20px;
		margin-bottom:10px;
	}
	
	.deploy_options input[type="checkbox"] {
		margin: 0px;
		width: 32px;
		float: left;
	}
	.deploy_options .clearfix label > div {
		float: left;
		width: auto;
		font-weight: bold;
		padding-top: 5px;
		cursor: pointer;
	}
	
</style>
	
	<div id="result_output">
		<div class="alert alert-error">
			<button type="button" class="close fui-cross"></button>
			<span id="error_message"></span>
		</div>
	</div>

	<div class="content" id="content1">	

		<ul id="maintabs" class="nav nav-tabs nav-append-content">
        	<li class="active"><a class="test_result_link" href="#tests_results" data-toggle="tab">Test Results</a></li>
        	<li class=""><a href="#class_coverage" data-toggle="tab">Class Coverage</a></li>
        	<li class=""><a href="#trigger_coverage" data-toggle="tab">Trigger Coverage</a></li>
        	<li class=""><a href="#warnings" data-toggle="tab">Warnings</a></li>
        	<li class=""><a href="#log" data-toggle="tab">Debug Log</a></li>
		</ul> 

		<div class="tab-content" id="main-tab-content">
			<div id="tests_results" class="tab-pane active">
				<div id="result_wrapper" style="-webkit-border-radius: 4px 4px 4px 4px;overflow-y:auto;padding:0px;position:relative;">
					{% for w in result['codeCoverageWarnings'] -%}
						{% if w['name'] == None -%}
						<div class="alert alert-error">
							<span><i class="icon-exclamation-sign icon-2x pull-left"></i>&nbsp;{{ w['message'] }}</span>
						</div>
						{%- endif %}
					{%- endfor %}

					{% for cls, tests in result['results_normal'].items() -%}
							
						<div class="alert-message block-message-custom white" style="margin-bottom:0px;padding: 5px;-webkit-border-radius: 4px 4px 0px 0px;">
								<p style="float:left;"><strong>{{ cls }}.cls</strong></p>
								<p style="float:right;"><strong>{{ result['pass_fail'][cls]['pass'] }}/{{ result['pass_fail'][cls]['pass']+result['pass_fail'][cls]['fail'] }}&nbsp;tests passed</strong></p>
							<div style="clear:both;"></div>	
						</div>

						<table class="table table-striped test_result" style="-webkit-border-radius: 0px 0px 4px 4px;">
							<thead>
								<tr>
									<th>Test Method</th>
									<th>Result</th>
									<th>Message</th>
								</tr>
							</thead>
							<tbody>
								{% for test in tests -%}
									<tr>
										<td style="width:210px;">{{ test['methodName'] }}</td>
										<td style="width:45px;">
											{% if 'stackTrace' not in test -%}
												<span class="label label-small label-success">Passed</span>
											{% else %}
												<span class="label label-small label-important">Failed</span>
											{%- endif %}
										</td>
										<td>
											{% if 'message' in test %}
												{{ test['message'] }} 
											{% endif %}
											{% if 'stackTrace' in test -%}
												<br/><br/>
												<span class="label">Stack Trace</span><br/>{{ test['stackTrace'] }}
											{%- endif %}
										</td>
									</tr>
								{%- endfor %}
							</tbody>
						</table>
					{%- endfor %}
				</div>
			</div>
			<div id="class_coverage" class="tab-pane">
				<div class="item-search class">
					<div class="control-group large">
					    <input style="height:34px;width:100%" class="span12" type="text" placeholder="Search">
					</div>
				</div>
				<div id="class_coverage_wrapper" style="-webkit-border-radius: 4px 4px 4px 4px;overflow-y:auto;padding:0px;position:relative;">
					<div id="class_wrapper">
						<!-- START CLASS PROCESSING -->
						{% for r in result['codeCoverage']['classes'] -%}
							{% set coverage = r['percentCovered'] %}
							{% set coverage_class = r['coverageLevel'] %}
							{% set display = "block" %}
							{% set extension = "cls"  %}
							{% set directory = "classes" %}

						<div class="alert alert-{{ coverage_class }}">
						  	
							<h3>{{ r['name'] }}.{{ extension }} </h3>

							<div class="progress" style="height:22px;margin:10px 0px;">
								<div class="bar bar-{{ coverage_class }}" style="width: {{ coverage }}%;"></div>
							</div>

							<p>({{ coverage }}% covered)</p>

							{% if does_file_exist(r['name'], 'ApexClass') == True -%}
						    	<a href="#" class="btn btn-mini btn-info" onclick="toggleSourceButton(this, {{ loop.index }}, 'class')">Show Coverage</a>
							{%- endif %}
						</div>

							{% if does_file_exist(r['name'], 'ApexClass') == True -%}
							<table class='code' id="class_code_result_{{ loop.index }}">
								<tbody>
									{% for line in get_file_lines(r['name'], 'ApexClass') -%} 
										{% set file_line_number = loop.index %}
										{% set td_class = [] %}
										{% if 'locationsNotCovered' in r -%}
											{% for location in r['locationsNotCovered'] -%}
												{% if 'line' in location %}
													{% if location['line']|int == file_line_number -%}
														{% if td_class.append(1) %}{% endif %}
														{% break %}
													{%- endif %}
												{% endif %}
											{%- endfor %}
										{%- endif %}
										
										{% if td_class -%}
										   	<tr>
										    	<td class="line_numbers">{{ file_line_number }}</td>
										    	<td class="code not_covered">{{ htmlize(line) }}</td>
											</tr>
										{% else %}
											<tr>
										    	<td class="line_numbers">{{ file_line_number }}</td>
										    	<td class="code covered"> {{ htmlize(line) }} </td>
											</tr>
										{%- endif %}
										
									{%- endfor %}
								</tbody>
							</table>
							{%- endif %}

						{%- endfor %} 
						<!-- END CLASS PROCESSING --> 
					</div>
				</div>   
			</div>
			<div id="trigger_coverage" class="tab-pane">
				<div class="item-search trigger">
					<div class="control-group large">
					    <input style="height:34px;width:100%" class="span12" type="text" placeholder="Search">
					</div>
				</div>
				<div id="trigger_coverage_wrapper" style="-webkit-border-radius: 4px 4px 4px 4px;overflow-y:auto;padding:0px;position:relative;">
					

					<div id="trigger_wrapper">
						<!-- START TRIGGER PROCESSING -->
						{% for r in result['codeCoverage']['triggers'] -%}
							{% set coverage = r['percentCovered'] %}
							{% set coverage_class = r['coverageLevel'] %}
							{% set display = "block" %}
							{% set extension = "trigger"  %}
							{% set directory = "triggers" %}

						<div class="alert alert-{{ coverage_class }}">
						  	
							<h3>{{ r['name'] }}.{{ extension }} </h3>

							<div class="progress" style="height:22px;margin:10px 0px;">
								<div class="bar bar-{{ coverage_class }}" style="width: {{ coverage }}%;"></div>
							</div>

							<p>({{ coverage }}% covered)</p>
							{% if does_file_exist(r['name'], 'ApexTrigger') == True -%}
						    	<a href="#" class="btn btn-mini btn-info" onclick="toggleSourceButton(this, {{ loop.index }}, 'trigger')">Show Coverage</a>
							{%- endif %}
						</div>

							{% if does_file_exist(r['name'], 'ApexTrigger') == True -%}
							<table class='code' id="trigger_code_result_{{ loop.index }}">
								<tbody>
									{% for line in get_file_lines(r['name'], 'ApexTrigger') -%} 
										{% set file_line_number = loop.index %}
										{% set td_class = [] %}
										{% if 'locationsNotCovered' in r -%}
											{% for location in r['locationsNotCovered'] -%}
												{% if 'line' in location %}
													{% if location['line']|int == file_line_number %}
														{% if td_class.append(1) %}{% endif %}
														{% break %}
													{% endif %}
												{% endif %}
											{%- endfor %}
										{%- endif %}
										
										{% if td_class -%}
										   	<tr>
										    	<td class="line_numbers">{{ file_line_number }}</td>
										    	<td class="code not_covered">{{ htmlize(line) }}</td>
											</tr>
										{% else %}
											<tr>
										    	<td class="line_numbers">{{ file_line_number }}</td>
										    	<td class="code covered">{{ htmlize(line) }}</td>
											</tr>
										{%- endif %}
									{%- endfor %}
								</tbody>
							</table>
							{%- endif %}

						{%- endfor %} 
						<!-- END TRIGGER PROCESSING --> 
					</div>
				</div>
			</div>
			<div id="warnings" class="tab-pane">
				<div id="warnings_coverage_wrapper" style="-webkit-border-radius: 4px 4px 4px 4px;overflow-y:auto;padding:0px;position:relative;">
					<div id="warnings_wrapper">
						<!--  WARNINGS -->
						<div class="alert-message block-message-custom white" style="margin-bottom:0px;padding: 5px;-webkit-border-radius: 4px 4px 0px 0px;">
								<p style="float:left;"><strong>Test Coverage Warnings</strong></p>
							<div style="clear:both;"></div>	
						</div>
						<table class="table table-striped test_result" style="-webkit-border-radius: 0px 0px 4px 4px;">
							<thead>
								<tr>
									<th>Metadata</th>
									<th>Message</th>
								</tr>
							</thead>
							<tbody>
								{% for w in result['codeCoverageWarnings'] %}
									{% if 'name' in w and w['name'] != None %}
										<tr>
											<td>{{ w['name'] }}</td>					
											<td>{{ w['message'] }}</td>					
										</tr>   
									{% endif %}
								{% endfor %}
							</tbody>
						</table>  
						<!-- END WARNINGS -->
					</div>
				</div>
			</div>
			<div id="log" class="tab-pane">
				<div id="log_coverage_wrapper" style="-webkit-border-radius: 4px 4px 4px 4px;overflow-y:auto;padding:0px;position:relative;">
					<div id="log_wrapper" style="position:relative;">
						<a href="javascript:void(0)" class="btn btn-success btn-embossed" onclick="$('#log_selector').selectText();" style="padding: 3px 5px;font-size: .9em;top:0;right:10px;position:absolute;">Select Log Text</a>
						<div style="padding:10px;" id="log_selector">
							{{ htmlize(result['log']) }}
						</div>
					</div>
				</div>
			</div>
		</div> 
	</div>

	{% endblock %}


	{% block buttons %}					
		<button type="reset" class="btn btn-embossed" onclick="window.close();">Close</button>	
	{% endblock %}

	{% block body_js %}


<script>

	function handle_response(response) {
		$("#result_wrapper").html(response["body"])

		$("#class_coverage_wrapper").html(
			$("#class_wrapper").html()
			)
		$("#trigger_coverage_wrapper").html(
			$("#trigger_wrapper").html()
			)
		$("#warnings_coverage_wrapper").html(
			$("#warnings_wrapper").html()
			)
		$("#log_coverage_wrapper").html(
			$("#log_wrapper").html()
			)
		$("#class_wrapper").remove()
		$("#trigger_wrapper").remove()
		$("#warnings_wrapper").remove()
		$("#log_wrapper").remove()

		$(".results_hidden").show();
		if ($("#arcade").css("display") == "none") {
			//$(".results_hidden ul li:first-child").click();
			$("li.active").removeClass('active')
			$("div.active").removeClass('active')
			$('a.test_result_link').tab('show');
		}

		toggleRunningIndicator();
		$("#btnRunTests").show();
		notify_sound()
	}

	function toggleSourceButton(el, index, type) {
		console.log($(el).html())
		if ($(el).html() == "Show Coverage") {
			$(el).html("Hide Coverage").removeClass("btn-info");
		} else {
			$(el).html("Show Coverage").addClass("btn-info");
		}
		$("#"+type+"_code_result_"+index).toggle();        
	}

	$("#result_wrapper").height($(window).height() - 210)
	$("#class_coverage_wrapper").height($(window).height() - 260)
	$("#trigger_coverage_wrapper").height($(window).height() - 260)
	$("#warnings_coverage_wrapper").height($(window).height() - 210)
	$("#log_coverage_wrapper").height($(window).height() - 210)
	
	$("#category").change(function() {
		if (this.value == "Apex_code") {
			$("#levelwrapper").show()
		} else {
			$("#levelwrapper").hide()
		}
	})

	$(".stack-trace-tip").popover({})
</script>

{% endblock %}